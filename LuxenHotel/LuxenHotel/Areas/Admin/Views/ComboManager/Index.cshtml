@using LuxenHotel.Models.Entities.Booking
@model LuxenHotel.Models.ViewModels.Booking.ComboListViewModel

@section Styles {
    @Html.LibStyle("datatables/datatables.bundle.css")
}

@section Scripts {
    @Html.LibScript("datatables/datatables.bundle.js")

    <script>
        $(document).ready(function () {
            $('select[data-filter="accommodation"]').select2({
                placeholder: "Accommodation",
                allowClear: true,
                minimumResultsForSearch: Infinity
            });

            var table = $('#combo_table').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [
                    [10, 25, 50, -1],
                    [10, 25, 50, "All"]
                ],
                ordering: true,
                searching: true,
                columnDefs: [{
                    targets: 1,
                }, {
                    targets: 3,
                    orderable: false,
                    searchable: false
                }],
                language: {
                    emptyTable: "No combos available",
                    zeroRecords: "No matching combos found"
                },
                drawCallback: function () {
                    $('[data-kt-menu-trigger="click"]').each(function () {
                        if (!$(this).data('ktMenu')) {
                            new KTMenu($(this).get(0));
                        }
                    });
                }
            });

            $('input[data-filter="search"]').on('keyup', function () {
                table.search(this.value).draw();
            });

            $('select[data-filter="accommodation"]').on('change', function () {
                var accommodationId = $(this).val();
                $.fn.dataTable.ext.search.pop();
                if (accommodationId !== "") {
                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        var row = $(table.row(dataIndex).node());
                        var rowAccommodationId = row.attr('data-accommodation-id');
                        return rowAccommodationId === accommodationId;
                    });
                }
                table.draw();
            });

            $('#combo_table').on('click', '[data-kt-ecommerce-combo-filter="delete_row"]', function (e) {
                e.preventDefault();
                const comboId = $(this).data('combo-id');
                if (confirm('Are you sure you want to delete this combo?')) {
                    fetch(`/admin/combos/Delete/${comboId}`, {
                        method: 'DELETE'
                    }).then(response => {
                        if (response.ok) {
                            table.row($(this).closest('tr')).remove().draw();
                            alert('Combo deleted successfully.');
                        } else {
                            alert('Failed to delete combo.');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the combo.');
                    });
                }
            });

        }); 
    </script>
}

<div class="card card-flush">
    <!--begin::Card header-->
    <div class="card-header align-items-center py-5 gap-2 gap-md-5">
        <!--begin::Card title-->
        <div class="card-title">
            <!--begin::Search-->
            <div class="d-flex align-items-center position-relative my-1">
                <i class="fa-solid fa-magnifying-glass fs-3 position-absolute ms-4"></i>
                <input type="text" data-filter="search" class="form-control form-control-solid w-250px ps-12"
                    placeholder="Search Combo" />
            </div>
            <!--end::Search-->
        </div>
        <!--end::Card title-->
        <!--begin::Card toolbar-->
        <div class="card-toolbar flex-row-fluid justify-content-end gap-5">
            <div class="w-100 mw-200px">
                <!--begin::Select2-->
                <select class="form-select form-select-solid" data-control="select2" data-hide-search="true"
                    data-placeholder="Accommodation" data-filter="accommodation">
                    <option value="">All Accommodations</option>
                    @foreach (var accommodation in Model.Accommodations)
                    {
                        <option value="@accommodation.Id">@accommodation.Name</option>
                    }
                </select>
                <!--end::Select2-->
            </div>
            <!--begin::Add combo-->
            <a data-bs-target="#kt_modal_add_combo" data-bs-toggle="modal" class="btn btn-primary"> Add Combo </a>
            <!--end::Add combo-->
        </div>
        <!--end::Card toolbar-->
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body pt-0">
        <!--begin::Table-->
        <div class="dt-container dt-bootstrap5 dt-empty-footer">
            <div class="table-responsive">
                <table class="table align-middle table-row-dashed fs-6 gy-5" id="combo_table">

                    @Html.Partial("Partial/Index/_AccommodationTableHeader")
                    <tbody class="fw-semibold text-gray-600">
                        @foreach (var combo in Model.Combos)
                        {
                            @Html.Partial("Partial/Index/_AccommodationTableRow", combo)
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@Html.Partial("Partial/Index/_AddComboForm", Model)